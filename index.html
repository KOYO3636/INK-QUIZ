<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inkit - Ink Trivia Quiz</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Ethers.js -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
</head>
<body class="bg-[#0a0d14] text-white font-sans overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CONFIGURATION ---
        const INK_CHAIN_ID_HEX = '0xde91'; // Ink Mainnet (57073)
        const PLAY_FEE = "0.0002";    // L-fees b l-ETH
        const TREASURY_ADDRESS = "0xF9A612DD8E961211345C67F180CE95Aa6Fe2C760"; 

        // --- Icons ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                wallet: <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4M4 6v12c0 1.1.9 2 2 2h14v-4M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path>,
                lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>,
                clock: <circle cx="12" cy="12" r="10"></circle>,
                check: <polyline points="20 6 9 17 4 12"></polyline>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const QUESTIONS = [
            { question: "What is Ink?", options: ["Layer 2 on Ethereum", "A Layer 1 Network", "A simple NFT", "A centralized exchange"], answer: 0 },
            { question: "Which technology powers the Ink network?", options: ["Polygon CDK", "OP Stack", "Cosmos SDK", "Zk-Sync"], answer: 1 },
            { question: "What is the native token used for gas fees in Ink?", options: ["INK", "USDT", "ETH", "USDC"], answer: 2 },
            { question: "Is the Ink network Open Source?", options: ["No", "Only the bridge", "Yes", "Not yet announced"], answer: 2 },
            { question: "Which wallet supports Ink mainnet?", options: ["Only MetaMask", "Only Rabby", "Both Rabby & MetaMask", "None yet"], answer: 2 }
        ];

        function App() {
            const [account, setAccount] = useState('');
            const [chainId, setChainId] = useState('');
            const [gameState, setGameState] = useState('CONNECT'); // CONNECT, PAY, PLAYING, END
            const [currentIdx, setCurrentIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(60);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('');

            // Helper to normalize chainId
            const normalizeChainId = (id) => {
                if (!id) return '';
                return id.toString().startsWith('0x') ? id.toLowerCase() : '0x' + parseInt(id).toString(16).toLowerCase();
            };

            // --- Wallet Logic ---
            const connectWallet = async () => {
                if (!window.ethereum) return setStatus('Please install Rabby or MetaMask');
                try {
                    const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const id = await window.ethereum.request({ method: 'eth_chainId' });
                    setAccount(accs[0]);
                    setChainId(normalizeChainId(id));
                    setStatus('');
                } catch (e) { setStatus('Connection failed'); }
            };

            const switchNet = async () => {
                if (!window.ethereum) return;
                setStatus('Switching network...');
                try {
                    // Try to switch first
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: INK_CHAIN_ID_HEX }],
                    });
                } catch (switchError) {
                    // This error code (4902) means the chain has not been added to the wallet.
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: INK_CHAIN_ID_HEX,
                                    chainName: 'Ink',
                                    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://rpc-gel.inkonchain.com'],
                                    blockExplorerUrls: ['https://explorer.inkonchain.com']
                                }],
                            });
                        } catch (addError) {
                            setStatus('Failed to add network');
                        }
                    } else {
                        setStatus('Switch failed: ' + switchError.message);
                    }
                }
            };

            // --- Payment Logic ---
            const handlePayment = async () => {
                setLoading(true);
                setStatus('Processing payment...');
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();
                    
                    const tx = await signer.sendTransaction({
                        to: TREASURY_ADDRESS,
                        value: ethers.utils.parseEther(PLAY_FEE)
                    });
                    
                    setStatus('Waiting for confirmation...');
                    await tx.wait();
                    
                    setGameState('PLAYING');
                    setStatus('');
                } catch (e) {
                    setStatus('Payment failed or rejected');
                } finally {
                    setLoading(false);
                }
            };

            // --- Game Logic ---
            useEffect(() => {
                let timer;
                if (gameState === 'PLAYING' && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                } else if (timeLeft === 0) {
                    setGameState('END');
                }
                return () => clearInterval(timer);
            }, [gameState, timeLeft]);

            const handleAnswer = (idx) => {
                if (QUESTIONS[currentIdx].answer === idx) setScore(s => s + 1);
                if (currentIdx + 1 < QUESTIONS.length) {
                    setCurrentIdx(prev => prev + 1);
                } else {
                    setGameState('END');
                }
            };

            // Watch for account/network changes
            useEffect(() => {
                if (window.ethereum) {
                    window.ethereum.on('accountsChanged', (accs) => setAccount(accs[0] || ''));
                    window.ethereum.on('chainChanged', (id) => setChainId(normalizeChainId(id)));
                }
            }, []);

            // Update UI based on connection
            useEffect(() => {
                const normInk = normalizeChainId(INK_CHAIN_ID_HEX);
                const normCurrent = normalizeChainId(chainId);

                if (account && normCurrent === normInk) {
                    if (gameState === 'CONNECT') setGameState('PAY');
                } else if (account && normCurrent !== normInk) {
                    setGameState('CONNECT');
                }
            }, [account, chainId, gameState]);

            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden bg-[#0a0d14]">
                    {/* Background Visuals */}
                    <div className="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-600/10 rounded-full blur-[120px]"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-blue-600/10 rounded-full blur-[120px]"></div>

                    <div className="w-full max-w-[480px] bg-[#131a2a] border border-white/10 rounded-[32px] p-2 shadow-2xl z-10">
                        <div className="bg-[#0d111c] rounded-[26px] p-8 text-center">
                            
                            {gameState === 'CONNECT' && (
                                <>
                                    <div className="mb-6 inline-flex p-4 bg-purple-500/10 rounded-full text-purple-500">
                                        <Icon name="wallet" size={48} />
                                    </div>
                                    <h1 className="text-3xl font-black mb-4 tracking-tight uppercase italic text-white">Ink Trivia Quiz</h1>
                                    <p className="text-slate-400 mb-8 text-sm leading-relaxed">To start, please connect and switch your wallet to the Ink Network.</p>
                                    {!account ? (
                                        <button onClick={connectWallet} className="w-full py-4 bg-purple-600 rounded-2xl font-black text-lg active:scale-95 transition-all text-white shadow-lg shadow-purple-600/20">CONNECT WALLET</button>
                                    ) : (
                                        <button onClick={switchNet} className="w-full py-4 bg-red-500/20 text-red-400 border border-red-500/20 rounded-2xl font-black text-lg active:scale-95 transition-all">SWITCH TO INK</button>
                                    )}
                                </>
                            )}

                            {gameState === 'PAY' && (
                                <>
                                    <div className="mb-6 inline-flex p-4 bg-blue-500/10 rounded-full text-blue-500">
                                        <Icon name="lock" size={48} />
                                    </div>
                                    <h1 className="text-2xl font-black mb-2 uppercase text-white">Unlock Game</h1>
                                    <p className="text-slate-400 mb-6 text-sm">Entry fee required to play and win rewards.</p>
                                    <div className="bg-[#131a2a] p-5 rounded-2xl border border-white/5 mb-8">
                                        <div className="text-3xl font-black text-white">{PLAY_FEE} ETH</div>
                                        <div className="text-[10px] text-slate-500 font-bold uppercase mt-1 tracking-widest">Ink Mainnet Fee</div>
                                    </div>
                                    <button 
                                        onClick={handlePayment} 
                                        disabled={loading}
                                        className="w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all disabled:opacity-50 text-white"
                                    >
                                        {loading ? "PROCESSING..." : "PAY & START"}
                                    </button>
                                </>
                            )}

                            {gameState === 'PLAYING' && (
                                <div className="text-left">
                                    <div className="flex justify-between items-center mb-8">
                                        <span className="text-[10px] font-black text-slate-500 uppercase bg-white/5 px-3 py-1 rounded-full tracking-widest">Question {currentIdx + 1}/5</span>
                                        <div className="flex items-center gap-2 text-purple-400 font-bold bg-purple-500/10 px-3 py-1 rounded-full">
                                            <Icon name="clock" size={14} /> {timeLeft}s
                                        </div>
                                    </div>
                                    <h2 className="text-xl font-bold mb-8 leading-snug min-h-[60px] text-white">{QUESTIONS[currentIdx].question}</h2>
                                    <div className="space-y-3">
                                        {QUESTIONS[currentIdx].options.map((opt, i) => (
                                            <button key={i} onClick={() => handleAnswer(i)} className="w-full text-left p-4 rounded-2xl border border-white/5 bg-white/5 hover:bg-white/10 hover:border-white/10 transition-all font-medium active:scale-[0.98] text-slate-200">
                                                {opt}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {gameState === 'END' && (
                                <>
                                    <div className="mb-6 inline-flex p-4 bg-green-500/10 rounded-full text-green-500">
                                        <Icon name="check" size={48} />
                                    </div>
                                    <h1 className="text-3xl font-black mb-2 uppercase italic tracking-tighter text-white">Quiz Done!</h1>
                                    <p className="text-slate-500 text-sm mb-8">You finished the Ink Trivia challenge.</p>
                                    <div className="bg-[#131a2a] p-8 rounded-[32px] border border-white/5 mb-8">
                                        <div className="text-5xl font-black text-purple-500 mb-1">{score}/5</div>
                                        <div className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Final Score</div>
                                    </div>
                                    <button onClick={() => window.location.reload()} className="w-full py-4 bg-white/5 border border-white/10 rounded-2xl font-black text-lg hover:bg-white/10 transition-all text-white">TRY AGAIN</button>
                                </>
                            )}

                            {status && <div className="mt-6 text-[11px] font-bold text-red-400 px-4 py-2 bg-red-500/10 rounded-xl border border-red-500/10 animate-pulse">{status}</div>}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
